var express=require("express"),favicon=require("serve-favicon"),session=require("express-session"),bodyParser=require("body-parser"),cookieParser=require("cookie-parser"),request=require("request"),path=require("path"),fs=require("fs"),app=express();app.use(require("helmet")());app.use(require("compression")());app.set("trust proxy",1);var secretKey=Date.now().toString(36)+Math.random().toString(36).substr(2,9),cookieName="iridium",hour=36e5,sessionOptions={secret:secretKey,name:cookieName,resave:!1,saveUninitialized:!1,cookie:{sameSite:!0,httpOnly:!0,expires:new Date(Date.now()+hour),maxAge:hour}};app.use(cookieParser(secretKey));app.use(session(sessionOptions));app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:!1}));var api_opc="http://ec2-54-88-0-215.compute-1.amazonaws.com:80",api_uri="http://ec2-54-88-0-215.compute-1.amazonaws.com:81",api_tagRecent="http://ec2-54-88-0-215.compute-1.amazonaws.com:83",api_uri_2="http://ec2-54-88-0-215.compute-1.amazonaws.com:84",api_alarms="http://ec2-54-88-0-215.compute-1.amazonaws.com:85",api_username="administrator",api_password="7eRmina7oR",_session;app.use(favicon(path.join(__dirname,"../public/favicon.ico")));app.use(["/bootstrap.min.css","/login/bootstrap.min.css"],express.static(path.join(__dirname,"../public/bower_components/bootstrap/dist/css/bootstrap.min.css")));app.get(["/login","/login/","/login?credentials=invalid"],function(req,res,next){var login_html=fs.readFileSync(path.join(__dirname+"/../public/login.html")).toString();if(login_html){res.send(login_html.replace("%year%",new Date().getFullYear()))}return});var credentials=[];app.post("/login",function(req,res,next){if(req.body.user_id&&req.body.user_password){credentials={user_id:req.body.user_id,password:req.body.user_password};var options={url:api_uri+"/signin",method:req.method,form:req.body,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){var requestBody=JSON.parse(body);if(!error&&200===response.statusCode){_session=req.session;_session.user_id=req.body.user_id;_session.organization_id=requestBody.organization_id;_session.currentServerTime=requestBody.currentServerTime;if("valid user"===requestBody.status){req.session.authenticated=!0;if(req.cookies.pageUrl){res.redirect(req.cookies.pageUrl)}else{res.redirect("/")}}else{res.redirect("/login?credentials=invalid");return}}else{res.redirect("/login?error=request");return}})}else{res.redirect("/login?credentials=invalid");return}});app.get("/getFingerPrint",function(req,res,next){"use strict";var options={url:api_alarms+"/getFingerPrint/"+req.session.user_id+"/"+req.session.organization_id.toLowerCase(),headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/createFingerPrint",function(req,res,next){"use strict";var options={url:api_alarms+"/createFingerPrint",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/updateFingerPrint",function(req,res,next){"use strict";var options={url:api_alarms+"/updateFingerPrint",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/removeFingerPrint/:fingerPrintID",function(req,res,next){"use strict";var options={url:api_alarms+"/removeFingerPrint/"+req.params.fingerPrintID,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getFingerPrintComments/:fingerPrintID",function(req,res,next){"use strict";var options={url:api_alarms+"/getFingerPrintComments/"+req.params.fingerPrintID,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/removeFingerPrintComment/:fingerPrintID/:commentID",function(req,res,next){"use strict";var options={url:api_alarms+"/removeFingerPrintComment/"+req.params.fingerPrintID+"/"+req.params.commentID,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getFingerPrintAlerts/:fingerPrintID",function(req,res,next){"use strict";var options={url:api_alarms+"/getFingerPrintAlerts/"+req.params.fingerPrintID,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/addFingerPrintComment",function(req,res,next){"use strict";var options={url:api_alarms+"/addFingerPrintComment",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/derivedTag/:derivedformula/:derivedTagName/:derivedDescription/:derivedTagId/:organizationId",function(req,res,next){"use strict";var options={url:api_uri_2+"/create/derivedTag",method:req.method,body:req.body,json:!0,headers:{userId:req.session.user_id,username:api_username,password:api_password,formula:req.params.derivedformula,derivedTagName:req.params.derivedTagName,description:req.params.derivedDescription,derivedTagId:req.params.derivedTagId,organizationId:req.params.organizationId,"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/aggregateTag/:tagName/:aggregatedTagName/:aggregationType/:aggregationInterval/:aggregationUnit/:description/:aggregatedTagId/:organizationId",function(req,res,next){"use strict";var options={url:api_uri_2+"/create/aggregatedTag",headers:{userId:req.session.user_id,username:api_username,password:api_password,tagId:req.params.tagName,aggregatedTagName:req.params.aggregatedTagName,aggregationType:req.params.aggregationType,aggregationInterval:req.params.aggregationInterval,aggregationUnit:req.params.aggregationUnit,description:req.params.description,aggregatedTagId:req.params.aggregatedTagId,organizationId:req.params.organizationId}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getTagList",function(req,res,next){"use strict";var options={url:api_tagRecent+"/getTagsDetail/"+req.session.organization_id,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getRecentTagList",function(req,res,next){"use strict";var options={url:api_tagRecent+"/retrieveFromTagRecent/"+req.session.user_id,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/insertTag",function(req,res,next){"use strict";var options={url:api_tagRecent+"/insertIntoTagRecent",method:req.method,formData:req.body,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/removeTag",function(req,res,next){"use strict";var options={url:api_tagRecent+"/removeFromTagRecent",method:req.method,formData:req.body,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getTagTrends/:tagName/:endDate/:startDate",function(req,res,next){"use strict";var options={url:api_uri_2+"/getVisualizationData/"+req.params.tagName+"/"+req.params.endDate+"/"+req.params.startDate,headers:{"Content-Type":"application/json",username:api_username,password:api_password}};request(options,function(error,response,body){if(error){return}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/valueSearch/:startDate/:endDate/:interval/:intervalUnit",function(req,res,next){"use strict";var options={url:api_uri_2+"/retrieve/valueBasedSearch",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,start_date:req.params.endDate,end_date:req.params.startDate,interval_unit:req.params.interval,interval:req.params.intervalUnit,"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/getOPCUAInstance",function(req,res,next){"use strict";var options={url:api_opc+"/getOPCUAInstance",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json"}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/updateOPCUAInstance/:opcua_name/:url/:description",function(req,res,next){"use strict";var options={url:api_opc+"/updateOPCUAInstance",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_name,url:req.params.url,description:req.params.description}};console.log("test",options);request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/deleteOPCUAInstance/:opcua_name",function(req,res,next){"use strict";var options={url:api_opc+"/deleteOPCUAInstance",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_name}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/addOPCUAInstance/:opcua_name/:url/:description",function(req,res,next){"use strict";var options={url:api_opc+"/addOPCUAInstance",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_name.toLowerCase(),url:req.params.url,description:req.params.description}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/getOPCUATag/:opcua_name",function(req,res,next){"use strict";var options={url:api_opc+"/getOPCUATag",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_name}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/updateOPCUATag/:opcua_unitname/:tag_name/:description/:opcua_tag_name",function(req,res,next){"use strict";var options={url:api_opc+"/updateOPCUATag",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_unitname,tag_name:req.params.tag_name,description:req.params.description,opcua_tag_name:req.params.opcua_tag_name}};console.log("test",options);request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/deleteOPCUATag/:opcua_name/:tag_name",function(req,res,next){"use strict";var options={url:api_opc+"/deleteOPCUATag",method:req.method,body:req.body,json:!0,headers:{"Content-Type":"application/json",username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),opcua_name:req.params.opcua_name,tag_name:req.params.tag_name}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.post("/addOPCUATag/:opcua_name/:tag_name/:description/:opcua_tag_name",function(req,res,next){"use strict";var options={url:api_opc+"/addOPCUATag",method:req.method,body:req.body,json:!0,headers:{username:api_username,password:api_password,organizationId:req.session.organization_id.toLowerCase(),"Content-Type":"application/json",opcua_name:req.params.opcua_name,tag_name:req.params.tag_name.toUpperCase(),opcua_tag_name:req.params.opcua_tag_name,description:req.params.description}};request(options,function(error,response,body){if(error){console.log(error)}else if(!error&&200===response.statusCode){res.send(body)}})});app.get("/getTagsDetailForTagManagement",function(req,res,next){"use strict";var options={url:api_tagRecent+"/getTagsDetailForTagManagement/"+req.session.organization_id,gzip:!0,headers:{username:api_username,password:api_password}};request(options,function(error,response,body){if(error){res.redirect("/login?credentials=invalid");return}else if(!error&&200===response.statusCode){console.log(body);res.send(body)}})});app.get("/logout",function(req,res,next){req.session.destroy();res.clearCookie(cookieName);res.clearCookie("pageUrl");res.redirect("/");return});app.use(function(req,res,next){if(!req.session.authenticated){res.redirect("/login/");return}next()});app.get("/",function(req,res,next){var index_html=fs.readFileSync(path.join(__dirname+"/../public/index.html")).toString();if(index_html){res.send(index_html.replace("%user_id%",req.session.user_id).replace("%organization_id%",req.session.organization_id))}});app.get("/about",function(req,res,next){res.send("about")});app.use(express.static(path.join(__dirname,"../")));app.use(function(req,res){res.status(404).end("error")});var port=process.env.PORT||3e3;app.listen(port,function(){console.log("Application running on http://localhost:%s",port)});